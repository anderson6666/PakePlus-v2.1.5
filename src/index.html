<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI答题网站 - 知识挑战平台</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // 知识蓝
                        secondary: '#f97316', // 活力橙
                        neutral: '#6b7280', // 中性灰
                        success: '#10b981', // 成功绿
                        danger: '#ef4444', // 错误红
                        dark: '#1e293b', // 深色背景
                        light: '#f8fafc' // 浅色背景
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .glass-dark {
                background: rgba(30, 41, 59, 0.75);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .progress-bar {
                transition: width 0.5s ease-in-out;
            }
            .option-hover:hover {
                transform: translateX(5px);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-question-circle text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">AI答题挑战</h1>
            </div>
            <div class="hidden md:flex space-x-6">
                <button id="nav-quiz" class="nav-btn flex items-center space-x-1 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-play-circle"></i>
                    <span>答题</span>
                </button>
                <button id="nav-generate" class="nav-btn flex items-center space-x-1 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-plus-circle"></i>
                    <span>生成题目</span>
                </button>
                <button id="nav-history" class="nav-btn flex items-center space-x-1 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-history"></i>
                    <span>历史记录</span>
                </button>
                <button id="nav-stats" class="nav-btn flex items-center space-x-1 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-bar-chart"></i>
                    <span>统计</span>
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <button id="settings-btn" class="text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-cog text-xl"></i>
                </button>
                <button id="mobile-menu-btn" class="md:hidden text-gray-700">
                    <i class="fa fa-bars text-xl"></i>
                </button>
            </div>
        </div>
        <!-- 移动端菜单 -->
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-200 animate-fade-in">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-2">
                <button id="mobile-nav-quiz" class="mobile-nav-btn flex items-center space-x-2 py-2 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-play-circle"></i>
                    <span>答题</span>
                </button>
                <button id="mobile-nav-generate" class="mobile-nav-btn flex items-center space-x-2 py-2 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-plus-circle"></i>
                    <span>生成题目</span>
                </button>
                <button id="mobile-nav-history" class="mobile-nav-btn flex items-center space-x-2 py-2 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-history"></i>
                    <span>历史记录</span>
                </button>
                <button id="mobile-nav-stats" class="mobile-nav-btn flex items-center space-x-2 py-2 text-gray-700 hover:text-primary transition-colors">
                    <i class="fa fa-bar-chart"></i>
                    <span>统计</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 页面内容容器 -->
        <div id="content-container">
            <!-- 答题页面 -->
            <section id="quiz-page" class="page active animate-fade-in">
                <div class="max-w-3xl mx-auto">
                    <!-- 进度条 -->
                    <div class="mb-6 bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-primary h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    
                    <h2 class="text-2xl font-bold mb-4">答题</h2>
                    
                    <!-- 题目卡片 -->
                    <div id="question-card" class="bg-white rounded-xl shadow-lg p-6 mb-6 animate-slide-in">
                        <div class="flex justify-between items-start mb-4">
                            <span id="question-number" class="bg-primary text-white text-sm font-medium px-3 py-1 rounded-full">题目 1/20</span>
                            <span id="question-timer" class="text-gray-500 text-sm">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span id="timer-display">00:00</span>
                            </span>
                        </div>
                        
                        <h2 id="question-text" class="text-xl font-bold text-gray-800 mb-6">
                            加载题目中...
                        </h2>
                        
                        <div id="options-container" class="space-y-3 mb-6">
                            <!-- 选项将通过JS动态生成 -->
                            <div class="animate-pulse bg-gray-100 rounded-lg p-4 mb-3"></div>
                            <div class="animate-pulse bg-gray-100 rounded-lg p-4 mb-3"></div>
                            <div class="animate-pulse bg-gray-100 rounded-lg p-4 mb-3"></div>
                            <div class="animate-pulse bg-gray-100 rounded-lg p-4"></div>
                        </div>
                        
                        <div id="answer-feedback" class="hidden mb-6 p-4 rounded-lg">
                            <!-- 答题反馈将通过JS动态生成 -->
                        </div>
                        
                        <div class="flex justify-between">
                            <button id="prev-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                                <i class="fa fa-arrow-left mr-2"></i>
                                上一题
                            </button>
                            <button id="next-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center">
                                下一题
                                <i class="fa fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow-md p-4 card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">当前已做</p>
                                    <p id="current-answered" class="text-2xl font-bold text-primary">0</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i class="fa fa-check-circle text-primary text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-4 card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">总做题数</p>
                                    <p id="total-answered" class="text-2xl font-bold text-secondary">0</p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-full">
                                    <i class="fa fa-list-alt text-secondary text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-4 card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">题目库存</p>
                                    <p id="question-stock" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <i class="fa fa-database text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 生成题目页面 -->
            <section id="generate-page" class="page hidden animate-fade-in">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fa fa-plus-circle text-primary mr-2"></i>
                            生成新题目
                        </h2>
                        
                        <form id="generate-form" class="space-y-4">
                            <div>
                                <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">学科</label>
                                <select id="subject" name="subject" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="小学">小学</option>
                                    <option value="初中">初中</option>
                                    <option value="高中">高中</option>
                                    <option value="大学">大学</option>
                                    <option value="生活技巧">生活技巧</option>
                                    <option value="工作技能">工作技能</option>
                                    <option value="急救知识">急救知识</option>
                                    <option value="必备常识">必备常识</option>
                                    <option value="万金油搭配">万金油搭配</option>
                                    <option value="其他">其他</option>
                                </select>
                                <p class="mt-1 text-sm text-gray-500">选择题目所属的学科</p>
                            </div>
                            
                            <div>
                                <label for="keywords" class="block text-sm font-medium text-gray-700 mb-1">关键词</label>
                                <input type="text" id="keywords" name="keywords" placeholder="输入关键词，用逗号分隔（如：细胞结构,光合作用,遗传规律）" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <p class="mt-1 text-sm text-gray-500">输入相关关键词，系统将基于学科和关键词生成题目</p>
                            </div>
                            
                            <div>
                                <label for="question-count" class="block text-sm font-medium text-gray-700 mb-1">题目数量</label>
                                <select id="question-count" name="question-count" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="5">5题</option>
                                    <option value="10">10题</option>
                                    <option value="15">15题</option>
                                    <option value="20">20题</option>
                                </select>
                            </div>

                            
                            
                            <div class="pt-4">
                                <button type="submit" id="generate-btn" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                                    <i class="fa fa-magic mr-2"></i>
                                    开始生成
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 生成状态卡片 -->
                    <div id="generation-status" class="hidden bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">生成进度</h3>
                        
                        <div class="mb-4 bg-gray-200 rounded-full h-2.5">
                            <div id="generation-progress" class="bg-secondary h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <p id="generation-message" class="text-gray-600 mb-4">准备生成题目...</p>
                        
                        <div id="generation-results" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- 生成结果将通过JS动态添加 -->
                        </div>
                        
                        <div class="mt-6 flex justify-between">
                            <button id="cancel-generation" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                                取消
                            </button>
                            <button id="finish-generation" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors hidden">
                                完成
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 历史记录页面 -->
            <section id="history-page" class="page hidden animate-fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <i class="fa fa-history text-primary mr-2"></i>
                                题目历史记录
                            </h2>
                            
                            <div class="flex space-x-2">
                                <select id="history-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                                    <option value="all">全部题目</option>
                                    <option value="correct">答对的题</option>
                                    <option value="incorrect">答错的题</option>
                                    <option value="unanswered">未答题</option>
                                </select>
                                <button id="clear-history" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                                    <i class="fa fa-trash mr-1"></i>
                                    清空
                                </button>
                            </div>
                        </div>
                        
                        <div id="history-list" class="space-y-4">
                            <!-- 历史题目将通过JS动态生成 -->
                            <div class="text-center py-12">
                                <i class="fa fa-clipboard-list text-gray-300 text-5xl mb-4"></i>
                                <p class="text-gray-500">暂无历史记录</p>
                                <button id="generate-first" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                    生成第一题
                                </button>
                            </div>
                        </div>
                        
                        <!-- 历史题目详情模态框 -->
                        <div id="history-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                            <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto animate-slide-in">
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <h3 id="modal-question-number" class="text-lg font-semibold text-gray-800">题目 #1</h3>
                                        <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                                            <i class="fa fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    
                                    <h4 id="modal-question-text" class="text-xl font-bold text-gray-800 mb-4">
                                        题目内容将显示在这里
                                    </h4>
                                    
                                    <div id="modal-options" class="space-y-3 mb-6">
                                        <!-- 选项将通过JS动态生成 -->
                                    </div>
                                    
                                    <div id="modal-answer" class="mb-4 p-4 rounded-lg">
                                        <!-- 答案将通过JS动态生成 -->
                                    </div>
                                    
                                    <div class="text-sm text-gray-500">
                                        <p>生成时间: <span id="modal-timestamp"></span></p>
                                        <p>关键词: <span id="modal-keywords"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 统计页面 -->
            <section id="stats-page" class="page hidden animate-fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fa fa-bar-chart text-primary mr-2"></i>
                            答题统计
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-blue-50 rounded-xl p-4 card-hover">
                                <p class="text-sm text-gray-500">总答题数</p>
                                <p id="stats-total-answered" class="text-3xl font-bold text-primary">0</p>
                            </div>
                            <div class="bg-green-50 rounded-xl p-4 card-hover">
                                <p class="text-sm text-gray-500">正确答题数</p>
                                <p id="stats-correct-answers" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-red-50 rounded-xl p-4 card-hover">
                                <p class="text-sm text-gray-500">错误答题数</p>
                                <p id="stats-incorrect-answers" class="text-3xl font-bold text-red-500">0</p>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-4 card-hover">
                                <p class="text-sm text-gray-500">正确率</p>
                                <p id="stats-accuracy" class="text-3xl font-bold text-secondary">0%</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-xl p-4" style="height: 300px;">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">答题趋势</h3>
                                <div style="height: 220px;">
                                    <canvas id="trends-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">题目分类</h3>
                                <canvas id="categories-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 设置模态框 -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 animate-slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">设置</h3>
                    <button id="close-settings" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="settings-form" class="space-y-4">
                    <div>
                        <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1">智谱AI API Key</label>
                        <input type="password" id="api-key" name="api-key" placeholder="输入您的智谱AI API Key" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        <p class="mt-1 text-sm text-gray-500">
                            <a href="https://bigmodel.cn/usercenter/proj-mgmt/apikeys" target="_blank" class="text-primary hover:underline">获取API Key</a>
                        </p>
                    </div>
                    

                    
                    <div class="pt-4">
                        <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            保存设置
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div id="toast" class="fixed bottom-6 right-6 bg-white rounded-lg shadow-lg p-4 max-w-sm transform translate-y-10 opacity-0 transition-all duration-300 z-50 hidden">
        <div class="flex items-start">
            <div id="toast-icon" class="flex-shrink-0 mr-3 mt-0.5">
                <!-- 图标将通过JS动态添加 -->
            </div>
            <div class="flex-1">
                <p id="toast-title" class="text-sm font-medium text-gray-900"></p>
                <p id="toast-message" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <button id="close-toast" class="ml-4 text-gray-400 hover:text-gray-500">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 主脚本 -->
    <script>
        // 全局变量
        let questions = [];
        let currentQuestionIndex = 0;
        let userData = {
            apiKey: '',
            totalAnswered: 0,
            currentStreak: 0,
            bestStreak: 0,
            correctAnswers: 0,
            questionHistory: []
        };
        let timerInterval = null;
        let generationInterval = null;
        let isGenerating = false;
        let trendsChart = null;
        let categoriesChart = null;
        
        // DOM元素
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const mobileNavButtons = document.querySelectorAll('.mobile-nav-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const settingsForm = document.getElementById('settings-form');
        const toast = document.getElementById('toast');
        const closeToast = document.getElementById('close-toast');
        
        // 答题页面元素
        const questionCard = document.getElementById('question-card');
        const questionNumber = document.getElementById('question-number');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const answerFeedback = document.getElementById('answer-feedback');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const timerDisplay = document.getElementById('timer-display');
        const currentAnsweredEl = document.getElementById('current-answered');
        const totalAnsweredEl = document.getElementById('total-answered');
        const questionStockEl = document.getElementById('question-stock');
        
        // 生成题目页面元素
        const generateForm = document.getElementById('generate-form');
        const generationStatus = document.getElementById('generation-status');
        const generationProgress = document.getElementById('generation-progress');
        const generationMessage = document.getElementById('generation-message');
        const generationResults = document.getElementById('generation-results');
        const cancelGeneration = document.getElementById('cancel-generation');
        const finishGeneration = document.getElementById('finish-generation');
        
        // 历史记录页面元素
        const historyFilter = document.getElementById('history-filter');
        const clearHistory = document.getElementById('clear-history');
        const historyList = document.getElementById('history-list');
        const historyDetailModal = document.getElementById('history-detail-modal');
        const closeModal = document.getElementById('close-modal');
        const modalQuestionNumber = document.getElementById('modal-question-number');
        const modalQuestionText = document.getElementById('modal-question-text');
        const modalOptions = document.getElementById('modal-options');
        const modalAnswer = document.getElementById('modal-answer');
        const modalTimestamp = document.getElementById('modal-timestamp');
        const modalKeywords = document.getElementById('modal-keywords');
        const generateFirstBtn = document.getElementById('generate-first');
        
        // 初始化函数
        function init() {
            // 清除旧的题目数据
            clearOldData();
            
            // 加载本地存储的数据
            loadUserData();
            loadQuestions();
            loadCurrentQuestionIndex();
            
            // 初始化事件监听器
            setupEventListeners();
            
            // 初始化统计图表
            initCharts();
            
            // 更新UI显示
            updateStatsDisplay();
            
            // 显示初始页面
            showPage('quiz-page');
            
            // 如果有题目，加载保存的题目索引
            if (questions.length > 0) {
                // 确保索引在有效范围内
                if (currentQuestionIndex >= questions.length) {
                    currentQuestionIndex = 0;
                }
                loadQuestion(currentQuestionIndex);
            } else {
                showToast('info', '欢迎使用AI答题挑战', '您的题库为空，请先生成一些题目');
                showPage('generate-page');
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 导航按钮点击事件
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = btn.id.replace('nav-', '') + '-page';
                    showPage(pageId);
                });
            });
            
            // 移动端导航按钮点击事件
            mobileNavButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = btn.id.replace('mobile-nav-', '') + '-page';
                    showPage(pageId);
                    mobileMenu.classList.add('hidden');
                });
            });
            
            // 移动端菜单切换
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // 设置按钮点击事件
            settingsBtn.addEventListener('click', () => {
                document.getElementById('api-key').value = userData.apiKey || '';
                settingsModal.classList.remove('hidden');
            });
            
            // 关闭设置模态框
            closeSettings.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
            
            // 设置表单提交
            settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const apiKey = document.getElementById('api-key').value;
                
                userData.apiKey = apiKey;
                
                saveUserData();
                settingsModal.classList.add('hidden');
                showToast('success', '设置已保存', '您的设置已成功更新');
            });
            
            // 关闭提示消息
            closeToast.addEventListener('click', () => {
                hideToast();
            });
            
            // 上一题按钮点击事件
            prevBtn.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion(currentQuestionIndex);
                }
            });
            
            // 下一题按钮点击事件
            nextBtn.addEventListener('click', () => {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    loadQuestion(currentQuestionIndex);
                } else {
                    // 如果是最后一题，检查是否需要自动生成新题目
                    checkQuestionStock();
                }
            });
            
            // 生成题目表单提交
            generateForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const subject = document.getElementById('subject').value;
                const keywords = document.getElementById('keywords').value;
                const count = parseInt(document.getElementById('question-count').value);
                
                if (!keywords.trim()) {
                    showToast('error', '生成失败', '请输入关键词');
                    return;
                }
                
                if (!userData.apiKey) {
                    showToast('error', '生成失败', '请先设置API Key');
                    settingsModal.classList.remove('hidden');
                    return;
                }
                
                generateQuestions(subject, keywords, count);
            });
            
            // 取消生成题目
            cancelGeneration.addEventListener('click', () => {
                if (isGenerating) {
                    clearInterval(generationInterval);
                    isGenerating = false;
                    generationStatus.classList.add('hidden');
                    generateForm.reset();
                    showToast('info', '已取消', '题目生成已取消');
                }
            });
            
            // 完成生成题目
            finishGeneration.addEventListener('click', () => {
                generationStatus.classList.add('hidden');
                generateForm.reset();
                showPage('quiz-page');
                showToast('success', '生成完成', `成功生成 ${questions.length} 道题目`);
                
                // 强制加载第一题，确保显示新生成的题目
                currentQuestionIndex = 0;
                loadQuestion(currentQuestionIndex);
            });
            
            // 历史记录筛选
            historyFilter.addEventListener('change', () => {
                renderHistoryList();
            });
            
            // 清空历史记录
            clearHistory.addEventListener('click', () => {
                if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                    questions = [];
                    saveQuestions();
                    renderHistoryList();
                    updateStatsDisplay();
                    showToast('success', '已清空', '历史记录已成功清空');
                }
            });
            
            // 关闭历史记录详情模态框
            closeModal.addEventListener('click', () => {
                historyDetailModal.classList.add('hidden');
            });
            
            // 点击模态框外部关闭
            historyDetailModal.addEventListener('click', (e) => {
                if (e.target === historyDetailModal) {
                    historyDetailModal.classList.add('hidden');
                }
            });
            
            // 生成第一题按钮
            generateFirstBtn.addEventListener('click', () => {
                showPage('generate-page');
            });
        }
        
        // 显示指定页面
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            
            document.getElementById(pageId).classList.remove('hidden');
            
            // 如果显示统计页面，更新图表
            if (pageId === 'stats-page') {
                updateCharts();
            }
            
            // 如果显示历史记录页面，渲染历史列表
            if (pageId === 'history-page') {
                renderHistoryList();
            }
        }
        
        // 清除旧的题目数据（仅执行一次）
        function clearOldData() {
            // 检查是否已经清除过旧数据
            const hasCleared = localStorage.getItem('hasClearedOldData');
            if (!hasCleared) {
                // 清除旧的题目数据
                localStorage.removeItem('quizQuestions');
                // 标记为已清除
                localStorage.setItem('hasClearedOldData', 'true');
            }
        }
        
        // 加载用户数据
        function loadUserData() {
            const savedUserData = localStorage.getItem('quizUserData');
            if (savedUserData) {
                const parsedData = JSON.parse(savedUserData);
                userData = {
                    ...userData,
                    ...parsedData
                };
            }
        }

        // 保存当前题目索引
        function saveCurrentQuestionIndex() {
            localStorage.setItem('currentQuestionIndex', currentQuestionIndex.toString());
        }

        // 加载当前题目索引
        function loadCurrentQuestionIndex() {
            const savedIndex = localStorage.getItem('currentQuestionIndex');
            if (savedIndex !== null) {
                currentQuestionIndex = parseInt(savedIndex, 10);
            }
        }
        
        // 保存用户数据
        function saveUserData() {
            localStorage.setItem('quizUserData', JSON.stringify(userData));
        }
        
        // 加载题目数据
        function loadQuestions() {
            // 先清除旧数据
            clearOldData();
            
            const savedQuestions = localStorage.getItem('quizQuestions');
            if (savedQuestions) {
                questions = JSON.parse(savedQuestions);
            }
        }
        
        // 保存题目数据
        function saveQuestions() {
            localStorage.setItem('quizQuestions', JSON.stringify(questions));
        }
        
        // 加载当前题目
        function loadQuestion(index) {
            // 保存当前题目索引
            saveCurrentQuestionIndex();
            
            // 清除计时器
            clearInterval(timerInterval);
            
            // 更新进度条
            const progress = ((index + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            // 更新题目编号
            questionNumber.textContent = `题目 ${index + 1}/${questions.length}`;
            
            const question = questions[index];
            
            // 更新题目文本
            questionText.textContent = question.question;
            
            // 清空选项容器
            optionsContainer.innerHTML = '';
            
            // 添加选项
            const options = ['A', 'B', 'C', 'D'];
            question.options.forEach((option, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer transition-all option-hover';
                
                // 如果题目已回答，显示正确/错误状态
                if (question.answered) {
                    if (options[i] === question.answer) {
                        optionDiv.classList.add('bg-green-50', 'border-green-300');
                    }
                    
                    if (options[i] === question.userAnswer && options[i] !== question.answer) {
                        optionDiv.classList.add('bg-red-50', 'border-red-300');
                    }
                }
                
                optionDiv.innerHTML = `
                    <div class="option-letter w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 font-medium text-gray-700">
                        ${options[i]}
                    </div>
                    <div class="option-text flex-1">${option}</div>
                `;
                
                // 添加点击事件
                if (!question.answered) {
                    optionDiv.addEventListener('click', () => {
                        selectOption(options[i]);
                    });
                }
                
                optionsContainer.appendChild(optionDiv);
            });
            
            // 显示或隐藏答题反馈
            if (question.answered) {
                showAnswerFeedback(question);
            } else {
                answerFeedback.classList.add('hidden');
            }
            
            // 更新导航按钮状态
            prevBtn.disabled = index === 0;
            
            if (index === questions.length - 1) {
                nextBtn.textContent = '完成';
                nextBtn.innerHTML = '完成 <i class="fa fa-check ml-2"></i>';
            } else {
                nextBtn.innerHTML = '下一题 <i class="fa fa-arrow-right ml-2"></i>';
            }
            
            // 开始计时器
            startTimer();
        }
        
        // 选择选项
        function selectOption(option) {
            const question = questions[currentQuestionIndex];
            question.userAnswer = option;
            question.answered = true;
            question.isCorrect = option === question.answer;
            
            // 保存当前题目索引
            saveCurrentQuestionIndex();
            
            // 更新统计数据
            if (question.isCorrect) {
                userData.correctAnswers++;
                userData.currentStreak++;
                userData.bestStreak = Math.max(userData.bestStreak, userData.currentStreak);
            } else {
                userData.currentStreak = 0;
            }
            
            userData.totalAnswered++;
            
            // 保存数据
            saveQuestions();
            saveUserData();
            
            // 更新UI
            loadQuestion(currentQuestionIndex);
            updateStatsDisplay();
        }
        
        // 显示答题反馈
        function showAnswerFeedback(question) {
            answerFeedback.classList.remove('hidden');
            
            if (question.isCorrect) {
                answerFeedback.className = 'bg-green-50 border border-green-200 text-green-800 p-4 rounded-lg';
                answerFeedback.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fa fa-check-circle text-green-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-lg font-medium">回答正确！</h3>
                            <p class="mt-1">正确答案是：${question.answer}</p>
                            <p class="mt-2 text-sm">${question.explanation || '解析暂不可用'}</p>
                        </div>
                    </div>
                `;
            } else {
                answerFeedback.className = 'bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg';
                answerFeedback.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fa fa-times-circle text-red-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-lg font-medium">回答错误</h3>
                            <p class="mt-1">您的答案：${question.userAnswer}</p>
                            <p class="mt-1">正确答案：${question.answer}</p>
                            <p class="mt-2 text-sm">${question.explanation || '解析暂不可用'}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // 开始计时器
        function startTimer() {
            let seconds = 0;
            timerDisplay.textContent = '00:00';
            
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // 生成题目
        async function generateQuestions(subject, keywords, count) {
            // 显示生成状态
            generationStatus.classList.remove('hidden');
            generationProgress.style.width = '0%';
            generationMessage.textContent = '正在调用智谱AI生成题目...';
            generationResults.innerHTML = '';
            
            isGenerating = true;
            let generatedCount = 0;
            
            // 循环生成指定数量的题目
            for (let i = 0; i < count; i++) {
                try {
                    // 更新进度
                    const progress = Math.min(((i + 1) / count) * 100, 90);
                    generationProgress.style.width = `${progress}%`;
                    generationMessage.textContent = `正在生成第 ${i + 1}/${count} 道题目...`;
                    
                    // 调用智谱AI生成题目
                    const question = await generateQuestionWithZhipuAI(subject, keywords);
                    
                    if (question) {
                        questions.push(question);
                        generatedCount++;
                        
                        // 添加到结果列表
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-3 bg-green-50 border border-green-200 rounded-lg mb-2';
                        resultItem.innerHTML = `
                            <div class="flex items-center">
                                <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                <span>题目 ${generatedCount}: ${question.question.substring(0, 50)}${question.question.length > 50 ? '...' : ''}</span>
                            </div>
                        `;
                        generationResults.appendChild(resultItem);
                        
                        // 保存题目
                        saveQuestions();
                        
                        // 短暂延迟，避免API调用过于频繁
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                } catch (error) {
                    console.error(`生成第${i + 1}题失败:`, error);
                    
                    // 添加错误信息到结果列表
                    const resultItem = document.createElement('div');
                    resultItem.className = 'p-3 bg-red-50 border border-red-200 rounded-lg mb-2';
                    resultItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fa fa-times-circle text-red-500 mr-2"></i>
                            <span>题目 ${i + 1}: 生成失败 - ${error.message}</span>
                        </div>
                    `;
                    generationResults.appendChild(resultItem);
                }
            }
            
            // 生成完成
            generationProgress.style.width = '100%';
            generationMessage.textContent = `题目生成完成！成功生成 ${generatedCount}/${count} 道题目`;
            finishGeneration.classList.remove('hidden');
            isGenerating = false;
            
            // 更新统计显示
            updateStatsDisplay();
        }
        
        // 使用智谱AI生成题目
        async function generateQuestionWithZhipuAI(subject, keywords) {
            if (!userData.apiKey) {
                throw new Error('请先设置智谱AI API Key');
            }
            
            const prompt = `请基于学科"${subject}"和关键词"${keywords}"生成一道高中${subject}选择题。题目要专业、准确，包含4个选项（A、B、C、D），其中只有一个正确答案。请按照以下JSON格式输出：
{
  "question": "题目内容",
  "options": ["选项A", "选项B", "选项C", "选项D"],
  "answer": "正确答案（A/B/C/D）",
  "explanation": "答案解析"
}`;
            
            try {
                const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userData.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'glm-4',
                        messages: [
                            {
                                role: 'system',
                                content: `你是一个专业的${subject}教师，擅长生成高质量的${subject}选择题。`
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`智谱AI API调用失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
                    throw new Error('智谱AI返回的数据格式不正确');
                }
                
                const content = data.choices[0].message.content;
                
                // 提取JSON部分
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('无法从AI响应中提取JSON格式');
                }
                
                const questionData = JSON.parse(jsonMatch[0]);
                
                // 验证必要字段
                if (!questionData.question || !questionData.options || !questionData.answer || !questionData.explanation) {
                    throw new Error('AI响应格式不完整');
                }
                
                // 创建新题目对象
                const newQuestion = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    question: questionData.question,
                    options: questionData.options,
                    answer: questionData.answer.toUpperCase(),
                    explanation: questionData.explanation,
                    keywords: [`${subject}`, ...keywords.split(',').map(k => k.trim())],
                    timestamp: Date.now(),
                    answered: false,
                    userAnswer: null,
                    isCorrect: false
                };
                
                return newQuestion;
            } catch (error) {
                if (error.message.includes('401')) {
                    throw new Error('API Key无效或已过期');
                } else if (error.message.includes('429')) {
                    throw new Error('API调用频率过高，请稍后再试');
                } else if (error.message.includes('Network')) {
                    throw new Error('网络连接失败，请检查网络');
                } else {
                    throw error;
                }
            }
        }
        

        
        // 检查题目库存
        function checkQuestionStock() {
            const threshold = userData.refreshThreshold || 20;
            const unansweredQuestions = questions.filter(q => !q.answered).length;
            
            if (userData.autoRefresh && unansweredQuestions < threshold) {
                // 获取最近使用的关键词
                let recentKeywords = 'JavaScript,HTML,CSS,前端开发';
                if (questions.length > 0) {
                    const recentQuestion = questions[questions.length - 1];
                    if (recentQuestion.keywords && recentQuestion.keywords.length > 0) {
                        recentKeywords = recentQuestion.keywords.join(',');
                    }
                }
                
                // 计算需要生成的题目数量
                const neededCount = threshold - unansweredQuestions;
                
                showToast('info', '自动更新题目', `检测到题目库存不足，正在生成 ${neededCount} 道新题目`);
                
                // 生成新题目
                generateQuestions(recentKeywords, neededCount);
            }
        }
        
        // 更新统计显示
        function updateStatsDisplay() {
            const answeredQuestions = questions.filter(q => q.answered).length;
            const unansweredQuestions = questions.filter(q => !q.answered).length;
            
            currentAnsweredEl.textContent = answeredQuestions;
            totalAnsweredEl.textContent = userData.totalAnswered;
            questionStockEl.textContent = questions.length;
        }
        
        // 渲染历史记录列表
        function renderHistoryList() {
            const filter = historyFilter.value;
            let filteredQuestions = [...questions];
            
            // 根据筛选条件过滤题目
            switch (filter) {
                case 'correct':
                    filteredQuestions = questions.filter(q => q.answered && q.isCorrect);
                    break;
                case 'incorrect':
                    filteredQuestions = questions.filter(q => q.answered && !q.isCorrect);
                    break;
                case 'unanswered':
                    filteredQuestions = questions.filter(q => !q.answered);
                    break;
            }
            
            // 按时间倒序排序
            filteredQuestions.sort((a, b) => b.timestamp - a.timestamp);
            
            // 清空历史列表
            historyList.innerHTML = '';
            
            // 如果没有题目，显示空状态
            if (filteredQuestions.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fa fa-clipboard-list text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">暂无历史记录</p>
                    </div>
                `;
                return;
            }
            
            // 添加题目到历史列表
            filteredQuestions.forEach((question, index) => {
                const date = new Date(question.timestamp);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                let statusIcon = '';
                let statusClass = '';
                
                if (!question.answered) {
                    statusIcon = 'fa-question-circle';
                    statusClass = 'text-gray-500';
                } else if (question.isCorrect) {
                    statusIcon = 'fa-check-circle';
                    statusClass = 'text-green-500';
                } else {
                    statusIcon = 'fa-times-circle';
                    statusClass = 'text-red-500';
                }
                
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-800 mb-2">${question.question.substring(0, 100)}${question.question.length > 100 ? '...' : ''}</h3>
                            <div class="flex items-center text-sm text-gray-500">
                                <span class="mr-4">
                                    <i class="fa fa-clock-o mr-1"></i>
                                    ${formattedDate}
                                </span>
                                <span>
                                    <i class="fa fa-tags mr-1"></i>
                                    ${question.keywords.join(', ')}
                                </span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <i class="fa ${statusIcon} ${statusClass} text-xl"></i>
                        </div>
                    </div>
                `;
                
                // 添加点击事件
                historyItem.addEventListener('click', () => {
                    showHistoryDetail(question, index);
                });
                
                historyList.appendChild(historyItem);
            });
        }
        
        // 显示历史记录详情
        function showHistoryDetail(question, index) {
            modalQuestionNumber.textContent = `题目 #${index + 1}`;
            modalQuestionText.textContent = question.question;
            
            // 清空选项容器
            modalOptions.innerHTML = '';
            
            // 添加选项
            const options = ['A', 'B', 'C', 'D'];
            question.options.forEach((option, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'flex items-center p-3 border border-gray-200 rounded-lg mb-2';
                
                // 如果题目已回答，显示正确/错误状态
                if (question.answered) {
                    if (options[i] === question.answer) {
                        optionDiv.classList.add('bg-green-50', 'border-green-300');
                    }
                    
                    if (options[i] === question.userAnswer && options[i] !== question.answer) {
                        optionDiv.classList.add('bg-red-50', 'border-red-300');
                    }
                }
                
                optionDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 font-medium text-gray-700">
                        ${options[i]}
                    </div>
                    <div class="flex-1">${option}</div>
                `;
                
                modalOptions.appendChild(optionDiv);
            });
            
            // 显示答案
            if (question.answered) {
                if (question.isCorrect) {
                    modalAnswer.className = 'bg-green-50 border border-green-200 text-green-800 p-4 rounded-lg';
                    modalAnswer.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fa fa-check-circle text-green-500 text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-lg font-medium">回答正确！</h3>
                                <p class="mt-1">正确答案是：${question.answer}</p>
                                <p class="mt-2">${question.explanation || '解析暂不可用'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    modalAnswer.className = 'bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg';
                    modalAnswer.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fa fa-times-circle text-red-500 text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-lg font-medium">回答错误</h3>
                                <p class="mt-1">您的答案：${question.userAnswer}</p>
                                <p class="mt-1">正确答案：${question.answer}</p>
                                <p class="mt-2">${question.explanation || '解析暂不可用'}</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                modalAnswer.className = 'bg-gray-50 border border-gray-200 text-gray-800 p-4 rounded-lg';
                modalAnswer.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fa fa-question-circle text-gray-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-lg font-medium">未回答</h3>
                            <p class="mt-1">此题目尚未回答</p>
                        </div>
                    </div>
                `;
            }
            
            // 显示时间戳和关键词
            const date = new Date(question.timestamp);
            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            modalTimestamp.textContent = formattedDate;
            modalKeywords.textContent = question.keywords.join(', ');
            
            // 显示模态框
            historyDetailModal.classList.remove('hidden');
        }
        
        // 初始化图表
        function initCharts() {
            // 答题趋势图表
            const trendsCtx = document.getElementById('trends-chart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '正确答题数',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // 题目分类图表
            const categoriesCtx = document.getElementById('categories-chart').getContext('2d');
            categoriesChart = new Chart(categoriesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['已回答', '未回答'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            '#3b82f6',
                            '#e5e7eb'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    cutout: '70%'
                }
            });
        }
        
        // 更新图表
        function updateCharts() {
            // 更新答题趋势图表
            const answeredQuestions = questions.filter(q => q.answered);
            const correctAnswers = questions.filter(q => q.answered && q.isCorrect).length;
            const incorrectAnswers = answeredQuestions.length - correctAnswers;
            const unansweredQuestions = questions.length - answeredQuestions.length;
            
            // 生成最近7天的日期标签
            const dateLabels = [];
            const correctData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                dateLabels.push(dateStr);
                
                // 计算当天的正确答题数
                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(date);
                dayEnd.setHours(23, 59, 59, 999);
                
                const dayCorrectAnswers = questions.filter(q => 
                    q.answered && 
                    q.isCorrect && 
                    q.timestamp >= dayStart.getTime() && 
                    q.timestamp <= dayEnd.getTime()
                ).length;
                
                correctData.push(dayCorrectAnswers);
            }
            
            trendsChart.data.labels = dateLabels;
            trendsChart.data.datasets[0].data = correctData;
            trendsChart.update();
            
            // 更新题目分类图表
            categoriesChart.data.datasets[0].data = [answeredQuestions.length, unansweredQuestions.length];
            categoriesChart.update();
            
            // 更新统计数据
            document.getElementById('stats-total-answered').textContent = userData.totalAnswered;
            document.getElementById('stats-correct-answers').textContent = userData.correctAnswers;
            document.getElementById('stats-incorrect-answers').textContent = userData.totalAnswered - userData.correctAnswers;
            
            const accuracy = userData.totalAnswered > 0 
                ? Math.round((userData.correctAnswers / userData.totalAnswered) * 100) 
                : 0;
            document.getElementById('stats-accuracy').textContent = `${accuracy}%`;
        }
        
        // 显示提示消息
        function showToast(type, title, message) {
            let iconClass = '';
            
            switch (type) {
                case 'success':
                    iconClass = 'fa-check-circle text-green-500';
                    break;
                case 'error':
                    iconClass = 'fa-times-circle text-red-500';
                    break;
                case 'info':
                    iconClass = 'fa-info-circle text-blue-500';
                    break;
                case 'warning':
                    iconClass = 'fa-exclamation-circle text-yellow-500';
                    break;
            }
            
            document.getElementById('toast-icon').innerHTML = `<i class="fa ${iconClass} text-xl"></i>`;
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
            
            // 自动隐藏
            setTimeout(() => {
                hideToast();
            }, 5000);
        }
        
        // 隐藏提示消息
        function hideToast() {
            toast.classList.add('translate-y-10', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>